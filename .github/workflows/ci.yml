name: CI

on:
  push:
    branches: [master]
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    name: pre-commit (ubuntu-latest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # For pull_request workflows, GitHub Actions uses a synthetic merge commit by default.
          # We check out the PR head SHA so coverage reports can be compared byte-for-byte with
          # reports generated locally on the same commit.
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Fetch remote branches
        run: git fetch --prune origin "+refs/heads/*:refs/remotes/origin/*"
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.91.1
        with:
          components: clippy, rustfmt, llvm-tools-preview
      - name: Read cargo-llvm-cov version
        id: llvm-cov-version
        run: echo "version=$(cat .cargo-llvm-cov-version)" >> "$GITHUB_OUTPUT"
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov@${{ steps.llvm-cov-version.outputs.version }}
          checksum: true
          fallback: cargo-binstall
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: Install pre-commit
        run: python -m pip install --upgrade pip pre-commit
      - name: Run pre-commit
        run: pre-commit run --all-files --show-diff-on-failure
      - name: Export llvm-cov report (per file)
        if: always()
        run: |
          set -euo pipefail
          if [ ! -d target/llvm-cov-target/coverage ]; then
            echo "No coverage artifacts found; skipping llvm-cov report export."
            exit 0
          fi
          cargo llvm-cov report --profile coverage --ignore-filename-regex 'crates/vt100-ctt/' > llvm-cov-report.txt
          cargo llvm-cov report --profile coverage --ignore-filename-regex 'crates/vt100-ctt/' --lcov --output-path llvm-cov-report.lcov
          gzip -9 -f llvm-cov-report.lcov
          python - <<'PY'
          import hashlib
          import pathlib

          report_path = pathlib.Path("llvm-cov-report.txt")
          digest = hashlib.sha256(report_path.read_bytes()).hexdigest()
          pathlib.Path("llvm-cov-report.sha256").write_text(
              f"{digest}  {report_path.as_posix()}\n",
              encoding="utf-8",
          )
          PY
          cat llvm-cov-report.sha256
          {
            echo "git_sha=$(git rev-parse HEAD)"
            cargo llvm-cov --version
            rustc -V
          } > llvm-cov-meta.txt
          tail -n 3 llvm-cov-report.txt
      - name: Verify committed llvm-cov report matches
        if: always()
        run: |
          set -euo pipefail
          case "${{ runner.os }}" in
            Linux) receipt_os="linux" ;;
            macOS) receipt_os="macos" ;;
            Windows) receipt_os="windows" ;;
            *) echo "ERROR: Unsupported runner.os: ${{ runner.os }}" >&2; exit 1 ;;
          esac

          receipt_dir="ci/llvm-cov-receipts/${receipt_os}"
          receipt_report="${receipt_dir}/llvm-cov-report.txt"
          receipt_sha="${receipt_dir}/llvm-cov-report.sha256"

          if [ ! -f "$receipt_report" ]; then
            echo "ERROR: Missing ${receipt_report}" >&2
            echo "Run locally: pre-commit install -t post-commit" >&2
            echo "Then make a commit (it will auto-amend in the report)." >&2
            exit 1
          fi
          diff -u "$receipt_report" llvm-cov-report.txt

          if [ ! -f "$receipt_sha" ]; then
            echo "ERROR: Missing ${receipt_sha}" >&2
            exit 1
          fi

          python - "$receipt_sha" <<'PY'
          import hashlib
          import pathlib
          import sys

          sha_path = pathlib.Path(sys.argv[1])
          line = sha_path.read_text(encoding="utf-8").strip()
          expected_hash, expected_path = line.split(maxsplit=1)
          report_path = pathlib.Path(expected_path)
          if not report_path.is_file():
              raise SystemExit(f"ERROR: sha references missing file: {expected_path}")

          actual_hash = hashlib.sha256(report_path.read_bytes()).hexdigest()
          if actual_hash != expected_hash:
              raise SystemExit(
                  f"ERROR: sha mismatch for {expected_path}: expected {expected_hash}, got {actual_hash}"
              )
          PY
      - name: Upload llvm-cov report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: llvm-cov-report
          path: |
            llvm-cov-report.txt
            llvm-cov-report.lcov.gz
            llvm-cov-report.sha256
            llvm-cov-meta.txt
          if-no-files-found: ignore
