name: CI

on:
  push:
    branches: [master]
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    name: pre-commit (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
            receipt_os: linux
            use_wsl: false
            enforce_coverage: true
          - os: macos-latest
            name: macos
            receipt_os: macos
            use_wsl: false
            enforce_coverage: false
          - os: windows-latest
            name: windows-wsl2
            receipt_os: windows
            use_wsl: true
            enforce_coverage: false
    steps:
      - uses: actions/checkout@v4
        with:
          # For pull_request workflows, GitHub Actions uses a synthetic merge commit by default.
          # We check out the PR head SHA so coverage reports can be compared byte-for-byte with
          # reports generated locally on the same commit.
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Fetch remote branches
        if: ${{ !matrix.use_wsl }}
        run: git fetch --prune origin "+refs/heads/*:refs/remotes/origin/*"
      - name: Set up Python
        if: ${{ !matrix.use_wsl }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install Rust
        if: ${{ !matrix.use_wsl }}
        uses: dtolnay/rust-toolchain@1.91.1
        with:
          components: clippy, rustfmt, llvm-tools-preview
      - name: Read cargo-llvm-cov version
        if: ${{ !matrix.use_wsl }}
        id: llvm-cov-version
        run: echo "version=$(cat .cargo-llvm-cov-version)" >> "$GITHUB_OUTPUT"
      - name: Install cargo-llvm-cov
        if: ${{ !matrix.use_wsl }}
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov@${{ steps.llvm-cov-version.outputs.version }}
          checksum: true
          fallback: cargo-binstall
      - name: Cache cargo
        if: ${{ !matrix.use_wsl }}
        uses: Swatinem/rust-cache@v2
      - name: Install pre-commit
        if: ${{ !matrix.use_wsl }}
        run: python -m pip install --upgrade pip pre-commit
      - name: Run pre-commit
        if: ${{ !matrix.use_wsl }}
        env:
          ENFORCE_COVERAGE: ${{ matrix.enforce_coverage }}
        run: |
          set -euo pipefail
          if [ "${ENFORCE_COVERAGE}" = "true" ]; then
            pre-commit run --all-files --show-diff-on-failure
          else
            SKIP=cargo-test,cargo-coverage pre-commit run --all-files --show-diff-on-failure
          fi

      - name: Run coverage hook (threshold-relaxed)
        if: ${{ !matrix.use_wsl && !matrix.enforce_coverage }}
        run: python3 scripts/precommit/run_cargo_hook.py coverage --no-fail-under

      - name: Resolve WSL context
        if: ${{ matrix.use_wsl }}
        id: wsl-context
        shell: pwsh
        run: |
          $distro = ""
          $distros = (wsl.exe -l -q) -split "`r?`n" |
            ForEach-Object { $_.Trim() } |
            Where-Object { $_ -ne "" -and $_ -notlike "docker-desktop*" }

          if ($distros.Count -eq 0) {
            Write-Host "No WSL distribution found; provisioning Ubuntu."
            wsl.exe --set-default-version 2
            wsl.exe --install --no-launch --distribution Ubuntu

            # Launch once to complete first-time distro registration.
            wsl.exe -d Ubuntu -e bash -lc "echo WSL ready"
            $distro = "Ubuntu"
          }

          if (-not $distro) {
            $distros = (wsl.exe -l -q) -split "`r?`n" |
              ForEach-Object { $_.Trim() } |
              Where-Object { $_ -ne "" -and $_ -notlike "docker-desktop*" }
            if ($distros.Count -eq 0) {
              throw "No WSL distribution found on runner."
            }
            if ($distros -contains "Ubuntu") {
              $distro = "Ubuntu"
            } else {
              $distro = $distros[0]
            }
          }

          $distro = $distro.Trim([char]0xFEFF)
          if (-not $distro) {
            throw "No WSL distribution found on runner."
          }

          $workspace = (wsl.exe -d $distro -e bash -lc "wslpath -a '${{ github.workspace }}'").Trim()
          if (-not $workspace) {
            throw "Failed to translate GitHub workspace path into WSL path."
          }

          "distro=$distro" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "workspace=$workspace" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Prepare WSL dependencies
        if: ${{ matrix.use_wsl }}
        shell: pwsh
        run: |
          $script = @'
          set -euo pipefail
          cd "${{ steps.wsl-context.outputs.workspace }}"

          if ! command -v python3 >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip python3-venv
          fi

          if ! command -v cc >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y build-essential
          fi

          PRECOMMIT_VENV="$PWD/.wsl-precommit-venv"
          PRECOMMIT_BIN="$PRECOMMIT_VENV/bin/pre-commit"
          rm -rf "$PRECOMMIT_VENV"
          if ! python3 -m venv "$PRECOMMIT_VENV" >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y python3-venv
            rm -rf "$PRECOMMIT_VENV"
            python3 -m venv "$PRECOMMIT_VENV"
          fi
          "$PRECOMMIT_VENV/bin/python" -m pip install --upgrade pip pre-commit
          export PATH="$HOME/.cargo/bin:$PATH"

          if ! command -v rustup >/dev/null 2>&1; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
          fi

          source "$HOME/.cargo/env"

          toolchain="$(awk -F '"' '/channel =/ { print $2 }' rust-toolchain.toml | head -n 1)"
          if [ -n "$toolchain" ]; then
            rustup toolchain install "$toolchain" --profile minimal --component clippy,rustfmt,llvm-tools-preview
            rustup default "$toolchain"
          fi

          required_cov="$(cat .cargo-llvm-cov-version)"
          installed_cov="$(cargo llvm-cov --version 2>/dev/null | awk '{print $2}' || true)"
          if [ "$installed_cov" != "$required_cov" ]; then
            cargo install cargo-llvm-cov --version "$required_cov" --locked --force
          fi

          rustc -V
          cargo -V
          cargo llvm-cov --version
          "$PRECOMMIT_BIN" --version
          '@
          $script = $script -replace "`r", ""
          wsl.exe -d '${{ steps.wsl-context.outputs.distro }}' -e bash -lc "$script"

      - name: Fetch remote branches (WSL)
        if: ${{ matrix.use_wsl }}
        shell: pwsh
        run: |
          $script = @'
          set -euo pipefail
          cd "${{ steps.wsl-context.outputs.workspace }}"
          git fetch --prune origin "+refs/heads/*:refs/remotes/origin/*"
          '@
          $script = $script -replace "`r", ""
          wsl.exe -d '${{ steps.wsl-context.outputs.distro }}' -e bash -lc "$script"

      - name: Normalize checkout line endings (WSL)
        if: ${{ matrix.use_wsl }}
        shell: pwsh
        run: |
          $script = @'
          set -euo pipefail
          cd "${{ steps.wsl-context.outputs.workspace }}"
          git config --local core.autocrlf false
          git config --local core.eol lf
          git reset --hard HEAD
          '@
          $script = $script -replace "`r", ""
          wsl.exe -d '${{ steps.wsl-context.outputs.distro }}' -e bash -lc "$script"

      - name: Run pre-commit (WSL)
        if: ${{ matrix.use_wsl }}
        shell: pwsh
        run: |
          $script = @'
          set -euo pipefail
          export PATH="$HOME/.cargo/bin:$PATH"
          cd "${{ steps.wsl-context.outputs.workspace }}"
          PRECOMMIT_BIN="$PWD/.wsl-precommit-venv/bin/pre-commit"
          if [ "${{ matrix.enforce_coverage }}" = "true" ]; then
            SKIP=ensure-post-commit-hook-installed "$PRECOMMIT_BIN" run --all-files --show-diff-on-failure
          else
            SKIP=ensure-post-commit-hook-installed,cargo-test,cargo-coverage "$PRECOMMIT_BIN" run --all-files --show-diff-on-failure
          fi
          '@
          $script = $script -replace "`r", ""
          wsl.exe -d '${{ steps.wsl-context.outputs.distro }}' -e bash -lc "$script"

      - name: Run coverage hook in WSL (threshold-relaxed)
        if: ${{ matrix.use_wsl && !matrix.enforce_coverage }}
        shell: pwsh
        run: |
          $script = @'
          set -euo pipefail
          export PATH="$HOME/.cargo/bin:$PATH"
          cd "${{ steps.wsl-context.outputs.workspace }}"
          python3 scripts/precommit/run_cargo_hook.py coverage --no-fail-under
          '@
          $script = $script -replace "`r", ""
          wsl.exe -d '${{ steps.wsl-context.outputs.distro }}' -e bash -lc "$script"

      - name: Export llvm-cov report (per file)
        if: ${{ always() && !matrix.use_wsl }}
        run: |
          set -euo pipefail
          if [ ! -d target/llvm-cov-target/coverage ]; then
            echo "No coverage artifacts found; skipping llvm-cov report export."
            exit 0
          fi
          cargo llvm-cov report --profile coverage --ignore-filename-regex 'crates/vt100-ctt/' > llvm-cov-report.txt
          cargo llvm-cov report --profile coverage --ignore-filename-regex 'crates/vt100-ctt/' --lcov --output-path llvm-cov-report.lcov
          gzip -9 -f llvm-cov-report.lcov
          python - <<'PY'
          import hashlib
          import pathlib

          report_path = pathlib.Path("llvm-cov-report.txt")
          digest = hashlib.sha256(report_path.read_bytes()).hexdigest()
          pathlib.Path("llvm-cov-report.sha256").write_text(
              f"{digest}  {report_path.as_posix()}\n",
              encoding="utf-8",
          )
          PY
          cat llvm-cov-report.sha256
          {
            echo "git_sha=$(git rev-parse HEAD)"
            cargo llvm-cov --version
            rustc -V
          } > llvm-cov-meta.txt
          tail -n 3 llvm-cov-report.txt

      - name: Export llvm-cov report (WSL)
        if: ${{ always() && matrix.use_wsl && steps.wsl-context.outcome == 'success' }}
        shell: pwsh
        run: |
          $script = @'
          set -euo pipefail
          export PATH="$HOME/.cargo/bin:$PATH"
          cd "${{ steps.wsl-context.outputs.workspace }}"
          if [ ! -d target/llvm-cov-target/coverage ]; then
            echo "No coverage artifacts found; skipping llvm-cov report export."
            exit 0
          fi
          cargo llvm-cov report --profile coverage --ignore-filename-regex 'crates/vt100-ctt/' > llvm-cov-report.txt
          cargo llvm-cov report --profile coverage --ignore-filename-regex 'crates/vt100-ctt/' --lcov --output-path llvm-cov-report.lcov
          gzip -9 -f llvm-cov-report.lcov
          python3 - <<'PY'
          import hashlib
          import pathlib

          report_path = pathlib.Path("llvm-cov-report.txt")
          digest = hashlib.sha256(report_path.read_bytes()).hexdigest()
          pathlib.Path("llvm-cov-report.sha256").write_text(
              f"{digest}  {report_path.as_posix()}\n",
              encoding="utf-8",
          )
          PY
          cat llvm-cov-report.sha256
          {
            echo "git_sha=$(git rev-parse HEAD)"
            cargo llvm-cov --version
            rustc -V
          } > llvm-cov-meta.txt
          tail -n 3 llvm-cov-report.txt
          '@
          $script = $script -replace "`r", ""
          wsl.exe -d '${{ steps.wsl-context.outputs.distro }}' -e bash -lc "$script"

      - name: Verify committed llvm-cov report matches
        if: ${{ always() && !matrix.use_wsl }}
        run: |
          set -euo pipefail
          receipt_os="${{ matrix.receipt_os }}"
          receipt_dir="ci/llvm-cov-receipts/${receipt_os}"
          receipt_report="${receipt_dir}/llvm-cov-report.txt"
          receipt_sha="${receipt_dir}/llvm-cov-report.sha256"

          if [ ! -f "$receipt_report" ]; then
            echo "ERROR: Missing ${receipt_report}" >&2
            echo "Run locally: pre-commit install -t post-commit" >&2
            echo "Then make a commit (it will auto-amend in the report)." >&2
            exit 1
          fi
          diff -u "$receipt_report" llvm-cov-report.txt

          if [ ! -f "$receipt_sha" ]; then
            echo "ERROR: Missing ${receipt_sha}" >&2
            exit 1
          fi

          python - "$receipt_sha" <<'PY'
          import hashlib
          import pathlib
          import sys

          sha_path = pathlib.Path(sys.argv[1])
          line = sha_path.read_text(encoding="utf-8").strip()
          expected_hash, expected_path = line.split(maxsplit=1)
          report_path = pathlib.Path(expected_path)
          if not report_path.is_file():
              raise SystemExit(f"ERROR: sha references missing file: {expected_path}")

          actual_hash = hashlib.sha256(report_path.read_bytes()).hexdigest()
          if actual_hash != expected_hash:
              raise SystemExit(
                  f"ERROR: sha mismatch for {expected_path}: expected {expected_hash}, got {actual_hash}"
              )
          PY

      - name: Verify committed llvm-cov report matches (WSL)
        if: ${{ always() && matrix.use_wsl && steps.wsl-context.outcome == 'success' }}
        shell: pwsh
        run: |
          $script = @'
          set -euo pipefail
          cd "${{ steps.wsl-context.outputs.workspace }}"
          receipt_os="${{ matrix.receipt_os }}"
          receipt_dir="ci/llvm-cov-receipts/${receipt_os}"
          receipt_report="${receipt_dir}/llvm-cov-report.txt"
          receipt_sha="${receipt_dir}/llvm-cov-report.sha256"

          if [ ! -f "$receipt_report" ]; then
            echo "ERROR: Missing ${receipt_report}" >&2
            echo "Run locally: pre-commit install -t post-commit" >&2
            echo "Then make a commit (it will auto-amend in the report)." >&2
            exit 1
          fi
          diff -u "$receipt_report" llvm-cov-report.txt

          if [ ! -f "$receipt_sha" ]; then
            echo "ERROR: Missing ${receipt_sha}" >&2
            exit 1
          fi

          python3 - "$receipt_sha" <<'PY'
          import hashlib
          import pathlib
          import sys

          sha_path = pathlib.Path(sys.argv[1])
          line = sha_path.read_text(encoding="utf-8").strip()
          expected_hash, expected_path = line.split(maxsplit=1)
          report_path = pathlib.Path(expected_path)
          if not report_path.is_file():
              raise SystemExit(f"ERROR: sha references missing file: {expected_path}")

          actual_hash = hashlib.sha256(report_path.read_bytes()).hexdigest()
          if actual_hash != expected_hash:
              raise SystemExit(
                  f"ERROR: sha mismatch for {expected_path}: expected {expected_hash}, got {actual_hash}"
              )
          PY
          '@
          $script = $script -replace "`r", ""
          wsl.exe -d '${{ steps.wsl-context.outputs.distro }}' -e bash -lc "$script"

      - name: Upload llvm-cov report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: llvm-cov-report-${{ matrix.receipt_os }}
          path: |
            llvm-cov-report.txt
            llvm-cov-report.lcov.gz
            llvm-cov-report.sha256
            llvm-cov-meta.txt
          if-no-files-found: ignore
